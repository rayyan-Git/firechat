<!DOCTYPE html>
<html lang="en">
<head>
    <!-- ... (head content remains the same) ... -->
</head>
<body>
    <!-- ... (body content remains the same) ... -->

    <script>
        // Firebase configuration (replace with your actual config)
        const firebaseConfig = {
            apiKey: "AIzaSyDAVJii9CUPUlUV8k0EpruSxri3LkPAjf0",
            authDomain: "firechat-demo-5b5fb.firebaseapp.com",
            databaseURL: "https://firechat-demo-5b5fb-default-rtdb.firebaseio.com",
            projectId: "firechat-demo-5b5fb",
            storageBucket: "firechat-demo-5b5fb.firebasestorage.app",
            messagingSenderId: "143043689653",
            appId: "1:143043689653:web:6a2bcb43cb914a65e192fc"
        };
        
        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const database = firebase.database();
        
        // DOM Elements
        // ... (DOM elements remain the same) ...
        
        // Current user data
        let currentUser = null;
        let currentMessageKey = null;
        let currentMessageElement = null;
        
        // Store Firebase references and callbacks
        let messagesRef = null;
        let userStatusRef = null;
        let currentUserRef = null;
        let messagesCallbacks = {
            added: null,
            changed: null,
            removed: null
        };
        let userStatusCallback = null;

        // Show login modal initially
        loginModal.style.display = 'flex';
        appContainer.style.display = 'none';
        
        // Close modal button
        closeModal.addEventListener('click', () => {
            loginModal.style.display = 'none';
        });
        
        // Sign in with Google
        googleLoginBtn.addEventListener('click', () => {
            const provider = new firebase.auth.GoogleAuthProvider();
            auth.signInWithPopup(provider)
                .catch(error => {
                    loginError.textContent = `Login failed: ${error.message}`;
                });
        });
        
        // Sign in as guest
        guestLoginBtn.addEventListener('click', () => {
            const name = displayNameInput.value.trim() || 'Guest User';
            
            auth.signInAnonymously()
                .then((userCredential) => {
                    const user = userCredential.user;
                    currentUser = {
                        uid: user.uid,
                        displayName: name,
                        photoURL: null,
                        isGuest: true
                    };
                    return user.updateProfile({ displayName: name });
                })
                .then(() => {
                    localStorage.setItem('firechat_user', JSON.stringify(currentUser));
                    startApp();
                })
                .catch((error) => {
                    loginError.textContent = `Guest login failed: ${error.message}`;
                });
        });

        // Logout
        logoutBtn.addEventListener('click', () => {
            // Clean up Firebase listeners
            cleanUpFirebaseListeners();
            
            auth.signOut();
            localStorage.removeItem('firechat_user');
            loginModal.style.display = 'flex';
            appContainer.style.display = 'none';
            currentUser = null;
        });
        
        // Close edit message modal
        closeEditModal.addEventListener('click', () => {
            editMessageModal.style.display = 'none';
        });
        
        cancelEditBtn.addEventListener('click', () => {
            editMessageModal.style.display = 'none';
        });
        
        // Save edited message
        saveEditBtn.addEventListener('click', () => {
            const newText = editMessageInput.value.trim();
            if (newText && currentMessageKey) {
                database.ref('messages/' + currentMessageKey).update({ 
                    text: newText,
                    edited: true 
                })
                .then(() => {
                    if (currentMessageElement) {
                        const contentEl = currentMessageElement.querySelector('.content');
                        contentEl.textContent = newText;
                        const timeEl = currentMessageElement.querySelector('.time');
                        timeEl.innerHTML = `${timeEl.textContent} <span class="edited-badge">(edited)</span>`;
                    }
                    editMessageModal.style.display = 'none';
                })
                .catch(error => {
                    console.error('Error updating message:', error);
                    alert('Failed to update message. Please try again.');
                });
            }
        });
        
        // Firebase Auth State Listener
        auth.onAuthStateChanged(user => {
            if (user) {
                currentUser = {
                    uid: user.uid,
                    displayName: user.displayName || 'Guest User',
                    photoURL: user.photoURL,
                    isGuest: user.isAnonymous
                };
                localStorage.setItem('firechat_user', JSON.stringify(currentUser));
                startApp();
            } else {
                loginModal.style.display = 'flex';
                appContainer.style.display = 'none';
            }
        });
        
        // Clean up Firebase listeners
        function cleanUpFirebaseListeners() {
            // Clean up messages listeners
            if (messagesRef) {
                if (messagesCallbacks.added) {
                    messagesRef.off('child_added', messagesCallbacks.added);
                }
                if (messagesCallbacks.changed) {
                    messagesRef.off('child_changed', messagesCallbacks.changed);
                }
                if (messagesCallbacks.removed) {
                    messagesRef.off('child_removed', messagesCallbacks.removed);
                }
                messagesRef = null;
            }
            
            // Clean up user status listener
            if (userStatusRef && userStatusCallback) {
                userStatusRef.off('value', userStatusCallback);
                userStatusRef = null;
            }
            
            // Clean up current user reference
            if (currentUserRef) {
                currentUserRef.onDisconnect().cancel();
                currentUserRef = null;
            }
            
            // Reset callbacks
            messagesCallbacks = {
                added: null,
                changed: null,
                removed: null
            };
            userStatusCallback = null;
        }
        
        function startApp() {
            loginModal.style.display = 'none';
            appContainer.style.display = 'flex';
            
            // Update user info
            userName.textContent = currentUser.displayName;
            
            // Set avatar
            if (currentUser.photoURL) {
                userAvatar.innerHTML = `<img src="${currentUser.photoURL}" style="width: 100%; height: 100%; border-radius: 16px;">`;
            } else {
                const initial = currentUser.displayName.charAt(0).toUpperCase();
                userAvatar.innerHTML = `<span style="font-size: 1.5rem; font-weight: bold;">${initial}</span>`;
            }
            
            // Initialize chat
            initChat();
            initOnlineUsers();
        }
        
        function initChat() {
            // Clear chat messages except the system message
            chatMessages.innerHTML = `
                <div class="message received">
                    <div class="sender">System Bot</div>
                    <div class="content">Welcome to FireChat Pro! This is a secure, professional chat environment.</div>
                    <div class="time">Just now</div>
                </div>
            `;
            
            // Clean up any existing listeners
            cleanUpFirebaseListeners();
            
            // Reference to the messages in database
            messagesRef = database.ref('messages').limitToLast(50);
            
            // Define callbacks
            messagesCallbacks.added = snapshot => {
                const message = snapshot.val();
                if (message.uid !== "system") {
                    addMessageToUI(message, snapshot.key);
                }
            };
            
            messagesCallbacks.changed = snapshot => {
                const message = snapshot.val();
                const messageEl = document.querySelector(`[data-key="${snapshot.key}"]`);
                if (messageEl) {
                    const contentEl = messageEl.querySelector('.content');
                    if (contentEl) contentEl.textContent = message.text;
                    const timeEl = messageEl.querySelector('.time');
                    if (message.edited) {
                        timeEl.innerHTML = `${timeEl.textContent} <span class="edited-badge">(edited)</span>`;
                    }
                }
            };
            
            messagesCallbacks.removed = snapshot => {
                const messageEl = document.querySelector(`[data-key="${snapshot.key}"]`);
                if (messageEl) messageEl.remove();
            };
            
            // Attach listeners
            messagesRef.on('child_added', messagesCallbacks.added);
            messagesRef.on('child_changed', messagesCallbacks.changed);
            messagesRef.on('child_removed', messagesCallbacks.removed);
            
            // Send message
            sendButton.addEventListener('click', sendMessage);
            messageInput.addEventListener('keypress', e => {
                if (e.key === 'Enter') sendMessage();
            });
        }
        
        function sendMessage() {
            const messageText = messageInput.value.trim();
            if (messageText) {
                const message = {
                    text: messageText,
                    name: currentUser.displayName,
                    timestamp: Date.now(),
                    uid: currentUser.uid,
                    isGuest: currentUser.isGuest
                };
                
                database.ref('messages').push(message)
                    .catch(error => {
                        console.error('Error sending message:', error);
                        const errorMsg = document.createElement('div');
                        errorMsg.classList.add('message', 'received');
                        errorMsg.innerHTML = `
                            <div class="sender">System Bot</div>
                            <div class="content">Failed to send message: ${error.message}</div>
                            <div class="time">Just now</div>
                        `;
                        chatMessages.appendChild(errorMsg);
                        chatMessages.scrollTop = chatMessages.scrollHeight;
                    });
                
                messageInput.value = '';
            }
        }
        
        function addMessageToUI(message, key) {
            const messageDiv = document.createElement('div');
            messageDiv.classList.add('message');
            
            const isCurrentUser = message.uid === currentUser.uid;
            messageDiv.classList.add(isCurrentUser ? 'sent' : 'received');
            messageDiv.dataset.key = key;
            messageDiv.dataset.timestamp = message.timestamp;
            
            const time = new Date(message.timestamp);
            const timeString = time.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            const badge = message.isGuest ? '<span class="badge">Guest</span>' : '';
            const editedBadge = message.edited ? ' <span class="edited-badge">(edited)</span>' : '';
            
            let messageActions = '';
            if (isCurrentUser) {
                messageActions = `
                    <div class="message-actions">
                        <button class="message-action edit-message" title="Edit">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="message-action delete-message" title="Delete for everyone">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                    </div>
                `;
            }
            
            messageDiv.innerHTML = `
                <div class="sender">${message.name} ${badge}</div>
                <div class="content">${message.text}</div>
                <div class="time">
                    ${timeString}${editedBadge}
                    ${messageActions}
                </div>
            `;
            
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
            
            if (isCurrentUser) {
                const editBtn = messageDiv.querySelector('.edit-message');
                const deleteBtn = messageDiv.querySelector('.delete-message');
                
                editBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    openEditMessageModal(message, key, messageDiv);
                });
                
                deleteBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    deleteMessage(key);
                });
            }
        }
        
        function openEditMessageModal(message, key, element) {
            currentMessageKey = key;
            currentMessageElement = element;
            editMessageInput.value = message.text;
            editMessageModal.style.display = 'flex';
        }
        
        function deleteMessage(key) {
            if (confirm('Are you sure you want to delete this message for everyone?')) {
                database.ref('messages/' + key).remove()
                    .catch(error => {
                        console.error('Error deleting message:', error);
                        alert('Failed to delete message. Please try again.');
                    });
            }
        }
        
        function initOnlineUsers() {
            userStatusRef = database.ref('users');
            currentUserRef = database.ref('users/' + currentUser.uid);
            
            // Set user status to online
            currentUserRef.set({
                name: currentUser.displayName,
                status: 'online',
                lastOnline: Date.now(),
                isGuest: currentUser.isGuest
            })
            .catch(error => {
                console.error('Error setting user status:', error);
            });
            
            // Update status when user disconnects
            currentUserRef.onDisconnect().update({
                status: 'offline',
                lastOnline: Date.now()
            })
            .catch(error => {
                console.error('Error setting onDisconnect:', error);
            });
            
            // Listen for online users
            userStatusCallback = snapshot => {
                onlineUsersList.innerHTML = '';
                let onlineCountValue = 0;
                
                // Add system bot
                const systemBot = document.createElement('li');
                systemBot.innerHTML = `
                    <div class="status" style="background: #f72585;"></div>
                    <div class="avatar-sm">S</div>
                    <span>System Bot</span>
                `;
                onlineUsersList.appendChild(systemBot);
                
                // Add real users
                snapshot.forEach(childSnapshot => {
                    const user = childSnapshot.val();
                    if (user.status === 'online' && user.name) {
                        onlineCountValue++;
                        const userItem = document.createElement('li');
                        userItem.innerHTML = `
                            <div class="status"></div>
                            <div class="avatar-sm">${user.name.charAt(0).toUpperCase()}</div>
                            <span>${user.name} ${user.isGuest ? '<span style="color: var(--accent); font-size: 0.8rem;">(Guest)</span>' : ''}</span>
                        `;
                        onlineUsersList.appendChild(userItem);
                    }
                });
                
                onlineCount.textContent = `(${onlineCountValue + 1})`;
                participantCount.textContent = onlineCountValue + 1;
            };
            
            userStatusRef.on('value', userStatusCallback);
        }
        
        // Initialize the app
        window.onload = function() {
            const savedUser = localStorage.getItem('firechat_user');
            if (savedUser) {
                currentUser = JSON.parse(savedUser);
                startApp();
            }
            
            setTimeout(() => {
                const welcomeMessage = {
                    text: "FireChat Pro offers enterprise-grade security with real-time messaging. Your conversations are protected with end-to-end encryption.",
                    name: "System Bot",
                    timestamp: Date.now(),
                    uid: "system",
                    isGuest: false
                };
                addMessageToUI(welcomeMessage, "system");
            }, 1000);
        };
    </script>
</body>
</html>
